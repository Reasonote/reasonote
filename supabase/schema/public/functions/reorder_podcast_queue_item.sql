---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.reorder_podcast_queue_item

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.reorder_podcast_queue_item)
------------------------------
CREATE OR REPLACE FUNCTION public.reorder_podcast_queue_item(p_item_id text, p_new_position double precision)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    v_for_user TEXT;
    v_current_position FLOAT;
    v_next_position FLOAT;
BEGIN
    v_for_user := public.current_rsn_user_id();

    -- Get the current position of the item
    SELECT position INTO v_current_position
    FROM public.podcast_queue_item
    WHERE id = p_item_id AND for_user = v_for_user;

    IF v_current_position IS NULL THEN
        RAISE EXCEPTION 'Item not found or not owned by the current user';
    END IF;

    -- Find the position of the item immediately after the new position
    SELECT position INTO v_next_position
    FROM public.podcast_queue_item
    WHERE for_user = v_for_user AND position > p_new_position
    ORDER BY position ASC
    LIMIT 1;

    -- Calculate the new position
    IF v_next_position IS NULL THEN
        v_next_position := p_new_position + 1;
    ELSE
        v_next_position := (p_new_position + v_next_position) / 2;
    END IF;

    -- Update the item's position
    UPDATE public.podcast_queue_item
    SET position = v_next_position
    WHERE id = p_item_id AND for_user = v_for_user;
END;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.reorder_podcast_queue_item)
---------------------------------------------------------------------------
