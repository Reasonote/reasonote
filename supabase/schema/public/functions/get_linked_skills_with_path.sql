---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.get_linked_skills_with_path

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.get_linked_skills_with_path)
------------------------------
CREATE OR REPLACE FUNCTION public.get_linked_skills_with_path(skill_id text, direction character varying)
 RETURNS TABLE(linked_skill_id text, path_to_linked_skill text[], skill_link_ids text[])
 LANGUAGE sql
 STABLE
AS $function$
WITH RECURSIVE linked_skills AS (
    SELECT 
        CASE 
            WHEN direction = 'GET_UPSTREAM' THEN upstream_skill
            WHEN direction = 'GET_DOWNSTREAM' THEN downstream_skill
        END AS skill,
        ARRAY[]::TEXT[] AS path,
        ARRAY[sl.id]::TEXT[] AS link_ids -- Include the id of the first link
    FROM skill_link sl
    WHERE 
        (direction = 'GET_UPSTREAM' AND downstream_skill = skill_id) OR 
        (direction = 'GET_DOWNSTREAM' AND upstream_skill = skill_id)

    UNION ALL

    SELECT 
        CASE 
            WHEN direction = 'GET_UPSTREAM' THEN sl.upstream_skill
            WHEN direction = 'GET_DOWNSTREAM' THEN sl.downstream_skill
        END,
        ls.path || CASE 
            WHEN direction = 'GET_UPSTREAM' THEN sl.downstream_skill
            WHEN direction = 'GET_DOWNSTREAM' THEN sl.upstream_skill
        END,
        ls.link_ids || sl.id -- Accumulate link ids
    FROM skill_link sl
    INNER JOIN linked_skills ls ON 
        (direction = 'GET_UPSTREAM' AND sl.downstream_skill = ls.skill) OR 
        (direction = 'GET_DOWNSTREAM' AND sl.upstream_skill = ls.skill)
    WHERE NOT (CASE 
            WHEN direction = 'GET_UPSTREAM' THEN sl.downstream_skill
            WHEN direction = 'GET_DOWNSTREAM' THEN sl.upstream_skill
        END = ANY(ls.path))
)
SELECT skill AS linked_skill_id, path || skill AS path_to_linked_skill, link_ids AS skill_link_ids FROM linked_skills;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.get_linked_skills_with_path)
---------------------------------------------------------------------------
