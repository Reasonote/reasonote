---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.update_chapter_root_skill_order

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.update_chapter_root_skill_order)
------------------------------
CREATE OR REPLACE FUNCTION public.update_chapter_root_skill_order(chapter_id text, target_order integer)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
DECLARE
    current_order integer;
    current_root_skill text;
BEGIN
    -- Retrieve current order and root_skill for the chapter
    SELECT root_skill, root_skill_order INTO current_root_skill, current_order
    FROM public.chapter
    WHERE id = chapter_id;

    -- Check if the chapter is part of a root_skill
    IF current_root_skill IS NULL THEN
        RAISE EXCEPTION 'chapter is not associated with a root_skill';
    END IF;

    -- Shift other chapters if necessary
    -- NOTE: We assume that root_skills are "dense", i.e., there are no gaps in the order numbers
    -- If there are gaps, the logic will be somewhat superfluous.
    IF target_order < current_order THEN
        -- Moving the chapter up in the order
        UPDATE public.chapter
        SET root_skill_order = root_skill_order + 1
        WHERE root_skill = current_root_skill AND
              root_skill_order >= target_order AND
              root_skill_order < current_order;
    ELSIF target_order > current_order THEN
        -- Moving the chapter down in the order
        UPDATE public.chapter
        SET root_skill_order = root_skill_order - 1
        WHERE root_skill = current_root_skill AND
              root_skill_order <= target_order AND
              root_skill_order > current_order;
    END IF;

    -- Update the order for the target chapter
    UPDATE public.chapter
        SET root_skill_order = target_order
        WHERE id = chapter_id;
END;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.update_chapter_root_skill_order)
---------------------------------------------------------------------------
