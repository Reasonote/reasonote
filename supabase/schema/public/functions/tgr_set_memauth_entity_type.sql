---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.tgr_set_memauth_entity_type

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.tgr_set_memauth_entity_type)
------------------------------
CREATE OR REPLACE FUNCTION public.tgr_set_memauth_entity_type()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  prefix text;
  matched_type text;
BEGIN
  -- Extract everything up to but not including the first underscore as the prefix
  prefix := substring(NEW.resource_entity_id from '^[^_]*'); -- This captures everything before underscore
  
  IF prefix IS NULL THEN
    RAISE EXCEPTION 'resource_entity_id "%" does not contain a known abbreviation', NEW.resource_entity_id;
  END IF;

  SELECT entity_type
    INTO matched_type
    FROM public.entity_type
    WHERE abbreviation = prefix;

  IF matched_type IS NULL THEN
    RAISE EXCEPTION 'No matching entity_type for abbreviation "%" from resource_entity_id "%"', prefix, NEW.resource_entity_id;
  END IF;

  NEW.resource_entity_type := matched_type;
  RETURN NEW;
END;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.tgr_set_memauth_entity_type)
---------------------------------------------------------------------------
