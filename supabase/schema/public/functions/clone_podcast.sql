---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.clone_podcast

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.clone_podcast)
------------------------------
CREATE OR REPLACE FUNCTION public.clone_podcast(orig_pod_id text)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  new_podcast_id TEXT;
BEGIN
  -- Clone the podcast
  INSERT INTO public.podcast (
    for_skill, for_user, title, topic, podcast_type, 
    transcript, metadata, special_instructions, outline,
    is_shared_version, original_podcast_id
  )
  SELECT 
    p.for_skill, p.for_user, p.title, p.topic, p.podcast_type, 
    p.transcript, p.metadata, p.special_instructions, p.outline,
    TRUE, p.id
  FROM public.podcast p
  WHERE p.id = orig_pod_id
  RETURNING id INTO new_podcast_id;

  -- Clone the podcast lines and their corresponding audio
  WITH new_lines AS (
    INSERT INTO public.podcast_line (
      podcast_id, speaker, dialogue, dig_deeper_topics, line_number
    )
    SELECT 
      new_podcast_id, speaker, dialogue, dig_deeper_topics, line_number
    FROM public.podcast_line
    WHERE podcast_id = orig_pod_id
    RETURNING id, line_number
  )
  INSERT INTO public.podcast_audio (
    podcast_line_id, speed, audio_file
  )
  SELECT 
    nl.id, pa.speed, pa.audio_file
  FROM public.podcast_audio pa
  JOIN public.podcast_line pl ON pa.podcast_line_id = pl.id
  JOIN new_lines nl ON pl.line_number = nl.line_number
  WHERE pl.podcast_id = orig_pod_id;

  RETURN new_podcast_id;
END;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.clone_podcast)
---------------------------------------------------------------------------
