---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.tgr_log_operation

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.tgr_log_operation)
------------------------------
CREATE OR REPLACE FUNCTION public.tgr_log_operation()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
    DECLARE
        _id uuid;
        _diff jsonb;
    BEGIN
        
        IF TG_OP = 'DELETE' THEN 
            _id = OLD.id;
        ELSE 
            _id = NEW.id;
        END IF;
        
        SELECT * 
        INTO _diff
        FROM json_diff_values(row_to_json(NEW.*), row_to_json(OLD.*));
        
        INSERT INTO public.operation_log (id, table_name, trigger_name, operation_when, operation_type, operation_level, entity_id, jsonb_diff, rsn_user_id, event_date)
        VALUES(extensions.uuid_generate_v4(), TG_TABLE_NAME, TG_NAME, TG_WHEN, TG_OP, TG_LEVEL, _id, _diff, current_rsn_user_id(), (now() AT TIME ZONE 'utc'::text));
        
        RETURN NEW;
    
    EXCEPTION 
        WHEN OTHERS THEN 
        RAISE NOTICE '% %', SQLERRM, SQLSTATE;
        RETURN NEW;
    END;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.tgr_log_operation)
---------------------------------------------------------------------------
