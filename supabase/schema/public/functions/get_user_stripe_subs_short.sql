---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.get_user_stripe_subs_short

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.get_user_stripe_subs_short)
------------------------------
CREATE OR REPLACE FUNCTION public.get_user_stripe_subs_short(mock mock__get_user_stripe_subs_short DEFAULT NULL::mock__get_user_stripe_subs_short)
 RETURNS TABLE(stripe_subscription_id text, stripe_product_id text, stripe_product_name text, stripe_product_lookup_key text, current_period_start timestamp without time zone, current_period_end timestamp without time zone, status text, canceled_at timestamp without time zone, cancellation_reason text)
 LANGUAGE plv8
AS $function$
    var customerIdResult = plv8.execute(`SELECT public.cur_user_stripe_customer_id() as stripe_customer_id;`);

    if (customerIdResult.length === 0) {
        throw new Error('Customer ID not found for the given user');
    }

    var stripeCustomerId = customerIdResult[0].stripe_customer_id;

    var getSubscriptionsQuery = `
        SELECT 
            s.id as stripe_subscription_id, 
            s.stripe_product_id, 
            p.name as stripe_product_name,
            p.name as stripe_product_lookup_key, 
            current_period_start, 
            current_period_end,
            s.status,
            s.canceled_at,
            s.cancellation_reason
        FROM public.stripe_subscriptions AS s
        JOIN public.stripe_products AS p ON s.stripe_product_id = p.id
        WHERE s.customer = $1
    `;
    var subscriptionsResult = plv8.execute(getSubscriptionsQuery, [stripeCustomerId]);

    return subscriptionsResult;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.get_user_stripe_subs_short)
---------------------------------------------------------------------------
