---------------------------------------------------------------------------
-- 
-- ⚠️ DO NOT EDIT THIS FILE!
-- THIS FILE WAS AUTOMATICALLY GENERATED FROM THE CONTENTS OF A CLEANLY-MIGRATED DATABASE.
-- 
-- ℹ️ To change the contents of this file, create a new migration under 'supabase/migrations/'
-- that makes the change you would like to see.
-- 
---------------------------------------------------------------------------
-- Function: public.tgr_user_auth_sync

---------------------------------------------------------------------------
-- BEGIN: PG_DUMP RESULT (FUNCTION: public.tgr_user_auth_sync)
------------------------------
CREATE OR REPLACE FUNCTION public.tgr_user_auth_sync()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    auth_user auth.users%ROWTYPE;
    split_names record;
    has_name_columns boolean;
BEGIN
    -- Get the auth user record
    SELECT * FROM auth.users 
        WHERE id = new.auth_id 
        INTO auth_user;

    -- Set the email
    new.auth_email := auth_user.email;

    -- Check if the target table has name columns
    SELECT EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = TG_TABLE_NAME
        AND column_name IN ('given_name', 'family_name')
    ) INTO has_name_columns;

    -- Only proceed with name updates if the table has the required columns
    IF has_name_columns THEN
        -- Try to get column values, defaulting to empty string if they don't exist
        IF (COALESCE(new.given_name, '') = '') AND 
           (COALESCE(new.family_name, '') = '') AND
           auth_user.raw_user_meta_data->>'name' IS NOT NULL THEN
            
            -- Split the name
            SELECT * INTO split_names 
            FROM public.split_full_name(auth_user.raw_user_meta_data->>'name');

            -- Update the names
            new.given_name := split_names.given_name;
            new.family_name := split_names.family_name;
        END IF;
    END IF;

    RETURN new;
END;
$function$



------------------------------
-- END: PG_DUMP RESULT (FUNCTION: public.tgr_user_auth_sync)
---------------------------------------------------------------------------
